rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------
    // Helpers
    // -------------------------
    function signedIn() {
      return request.auth != null;
    }

    function groupDoc(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId));
    }

    function groupExists(groupId) {
      return exists(/databases/$(database)/documents/groups/$(groupId));
    }

    // Memastikan user adalah member dari grup
    function isMember(groupId) {
      return signedIn()
        && groupExists(groupId)
        && request.auth.uid in groupDoc(groupId).data.memberIds;
    }

    // Memastikan user adalah admin dari grup
    function isGroupAdmin(groupId) {
      return signedIn()
        && groupExists(groupId)
        && request.auth.uid in groupDoc(groupId).data.adminIds;
    }

    // =========================
    // USERS
    // =========================
    match /users/{uid} {
      // Allow read to authenticated users (needed for searching users by email)
      allow read: if signedIn();

      // Only the user can create/update/delete their own profile
      allow create, update, delete: if signedIn() && request.auth.uid == uid;

      // =========================
      // FAQS & NOTIFICATIONS
      // =========================
      match /notifications/{notifId} {
        // Owner can read their own notifications
        allow read: if signedIn() && request.auth.uid == uid;

        // âœ… FIX: Allow ANY signed-in user to CREATE a notification
        // This is necessary because User A needs to write a notification to User B's collection
        allow create: if signedIn();

        // Owner can update (only isRead/readAt fields)
        allow update: if signedIn()
          && request.auth.uid == uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'isRead',
            'readAt',
            'updatedAt'
          ]);

        // Owner can delete their own notifications
        allow delete: if signedIn() && request.auth.uid == uid;
      }
    }

    // =========================
    // GROUPS
    // =========================
    match /groups/{groupId} {
      // Members can read group info
      allow read: if signedIn() && request.auth.uid in resource.data.memberIds;

      // Create: Creator must be in memberIds & adminIds
      allow create: if signedIn()
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.memberIds is list
        && request.resource.data.adminIds is list
        && request.auth.uid in request.resource.data.memberIds
        && request.auth.uid in request.resource.data.adminIds;

      // Update: Members can update (e.g. adding tasks triggering updates if any)
      allow update: if signedIn() && request.auth.uid in resource.data.memberIds;

      // Delete: Only Admin or Creator
      allow delete: if isGroupAdmin(groupId)
        || (signedIn() && request.auth.uid == resource.data.creatorId);

      // =========================
      // MESSAGES
      // =========================
      match /messages/{messageId} {
        allow read: if isMember(groupId);
        allow create: if isMember(groupId)
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.text.size() <= 2000
          && request.resource.data.createdAt is timestamp;
        allow update, delete: if isMember(groupId)
          && (resource.data.senderId == request.auth.uid || isGroupAdmin(groupId));
      }
    }

    // =========================
    // TASKS
    // =========================
    match /tasks/{taskId} {
      // Read: Member OR Assignee OR Creator
      allow read: if signedIn()
        && (
          (resource.data.groupId is string && isMember(resource.data.groupId))
          || resource.data.assigneeId == request.auth.uid
          || resource.data.createdBy == request.auth.uid
        );

      // Create: Member of the group
      allow create: if signedIn()
        && request.resource.data.groupId is string
        && isMember(request.resource.data.groupId)
        && request.resource.data.createdBy == request.auth.uid;

      // Update: Member of the group
      allow update: if signedIn()
        && resource.data.groupId is string
        && isMember(resource.data.groupId);

      // Delete: Admin or Creator
      allow delete: if signedIn()
        && resource.data.groupId is string
        && (
          isGroupAdmin(resource.data.groupId)
          || resource.data.createdBy == request.auth.uid
        );
    }
  }
}
